<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–ª–∞—Ç–µ–∂–µ–π</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    input[type="range"].slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: transform 0.1s ease;
    }
    
    input[type="range"].slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    
    input[type="range"].slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: transform 0.1s ease;
    }
    
    input[type="range"].slider::-moz-range-thumb:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    function startOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function endOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    function startOfYear(date) {
      return new Date(date.getFullYear(), 0, 1);
    }

    function endOfYear(date) {
      return new Date(date.getFullYear(), 11, 31);
    }

    function addMonths(date, count) {
      return new Date(date.getFullYear(), date.getMonth() + count, date.getDate());
    }

    function addWeeks(date, count) {
      const result = new Date(date);
      result.setDate(result.getDate() + count * 7);
      return result;
    }

    function addYears(date, count) {
      return new Date(date.getFullYear() + count, date.getMonth(), date.getDate());
    }

    function getDaysInMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    }

    function getFirstDayOfMonth(date) {
      const day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
      return day === 0 ? 6 : day - 1;
    }

    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    function formatDateKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º—ã —Å –ø—Ä–æ–±–µ–ª–æ–º –ø–æ—Å–ª–µ –¥–µ—Å—è—Ç–∫–æ–≤ —Ç—ã—Å—è—á
    function formatAmount(amount) {
      const formatted = amount.toLocaleString('ru-RU', { 
        maximumFractionDigits: 0,
        useGrouping: true
      });
      return formatted.replace(/,/g, ' ');
    }

    // –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —à–∞–≥–∞ —Å–ª–∞–π–¥–µ—Ä–∞
    function getSliderStep(value) {
      if (value < 1000) return 100;
      if (value < 5000) return 500;
      if (value < 10000) return 1000;
      if (value < 50000) return 5000;
      return 10000;
    }


    function SubscriptionCalendarApp() {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [modalOpen, setModalOpen] = useState(false);
      const [payments, setPayments] = useState([]);
      const [editingPaymentId, setEditingPaymentId] = useState(null);
      const [clickedPaymentInstance, setClickedPaymentInstance] = useState(null);
      
      // –§–æ—Ä–º–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      const [formLabel, setFormLabel] = useState("");
      const [formAmount, setFormAmount] = useState("");
      const [formFrequency, setFormFrequency] = useState("monthly");
      const [sliderValue, setSliderValue] = useState(1000);
      const sliderRef = useRef(null);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
      useEffect(() => {
        const saved = localStorage.getItem('calendar-payments');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            const paymentsWithDates = parsed.map(p => ({
              ...p,
              startDate: new Date(p.startDate),
              endDate: p.endDate ? new Date(p.endDate) : null
            }));
            setPayments(paymentsWithDates);
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
          }
        }
      }, []);

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
      useEffect(() => {
        if (payments.length > 0 || localStorage.getItem('calendar-payments')) {
          localStorage.setItem('calendar-payments', JSON.stringify(payments));
        }
      }, [payments]);

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
      useEffect(() => {
        if (formAmount) {
          const num = Number(formAmount.replace(/\s/g, '').replace(",", "."));
          if (!isNaN(num) && num >= 100 && num <= 1000000) {
            setSliderValue(num);
          }
        }
      }, [formAmount]);

      const handleDayClick = (day) => {
        setSelectedDate(day);
        setModalOpen(true);
        setFormLabel("");
        setFormAmount("1000");
        setSliderValue(1000);
        setFormFrequency("monthly");
        setEditingPaymentId(null);
        setClickedPaymentInstance(null);
      };

      const handlePaymentClick = (e, payment) => {
        e.stopPropagation();
        const basePayment = payments.find(p => p.id === payment.baseId);
        if (basePayment) {
          // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–º–µ–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
          const now = new Date();
          const paymentDate = new Date(payment.date);
          
          if (basePayment.frequency !== "one-time" && paymentDate > new Date(basePayment.startDate)) {
            setClickedPaymentInstance(payment);
            setEditingPaymentId(basePayment.id);
            setSelectedDate(paymentDate);
            setFormLabel(basePayment.label);
            setFormAmount(basePayment.amount.toString());
            setSliderValue(basePayment.amount);
            setFormFrequency(basePayment.frequency);
            setModalOpen(true);
          } else {
            // –û–±—ã—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            setEditingPaymentId(basePayment.id);
            setSelectedDate(new Date(basePayment.startDate));
            setFormLabel(basePayment.label);
            setFormAmount(basePayment.amount.toString());
            setSliderValue(basePayment.amount);
            setFormFrequency(basePayment.frequency);
            setClickedPaymentInstance(null);
            setModalOpen(true);
          }
        }
      };

      const handleCloseModal = () => {
        setModalOpen(false);
        setSelectedDate(null);
        setEditingPaymentId(null);
        setClickedPaymentInstance(null);
        setFormLabel("");
        setFormAmount("1000");
        setSliderValue(1000);
        setFormFrequency("monthly");
      };

      const handleSliderChange = (e) => {
        let value = Number(e.target.value);
        // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ —à–∞–≥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
        let step = 100;
        if (value >= 50000) step = 10000;
        else if (value >= 10000) step = 5000;
        else if (value >= 5000) step = 1000;
        else if (value >= 1000) step = 500;
        const rounded = Math.round(value / step) * step;
        const finalValue = Math.max(100, Math.min(100000, rounded));
        setSliderValue(finalValue);
        setFormAmount(formatAmount(finalValue));
      };

      const handleAmountInputChange = (e) => {
        let value = e.target.value.replace(/\s/g, '').replace(",", ".");
        setFormAmount(value);
        const num = Number(value);
        if (!isNaN(num) && num >= 100 && num <= 100000) {
          setSliderValue(num);
        }
      };

      const handleCancelFromNow = () => {
        if (!clickedPaymentInstance) return;
        
        const basePayment = payments.find(p => p.id === editingPaymentId);
        if (basePayment) {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º endDate –Ω–∞ –¥–µ–Ω—å –ø–µ—Ä–µ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
          const endDate = new Date(clickedPaymentInstance.date);
          endDate.setDate(endDate.getDate() - 1);
          
          setPayments((prev) => prev.map(p => 
            p.id === editingPaymentId 
              ? { ...p, endDate }
              : p
          ));
        }
        handleCloseModal();
      };

      const handleAddPayment = () => {
        if (!selectedDate) return;
        
        const parsedAmount = Number(formAmount.replace(/\s/g, '').replace(",", "."));
        if (isNaN(parsedAmount) || parsedAmount <= 0 || parsedAmount > 100000) {
          alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–æ—Ç 100 –¥–æ 100 000 ‚ÇΩ)");
          return;
        }

        if (editingPaymentId && !clickedPaymentInstance) {
          // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
          setPayments((prev) => prev.map(p => 
            p.id === editingPaymentId 
              ? {
                  ...p,
                  label: formLabel.trim() || "–ü–ª–∞—Ç—ë–∂",
                  amount: parsedAmount,
                  startDate: new Date(selectedDate),
                  frequency: formFrequency,
                  endDate: null
                }
              : p
          ));
        } else {
          // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
          const newPayment = {
            id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            label: formLabel.trim() || "–ü–ª–∞—Ç—ë–∂",
            amount: parsedAmount,
            startDate: new Date(selectedDate),
            frequency: formFrequency,
            endDate: null
          };
          setPayments((prev) => [...prev, newPayment]);
        }
        
        handleCloseModal();
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
          handleAddPayment();
        }
      };

      const handleRemovePayment = (id) => {
        setPayments((prev) => prev.filter((p) => p.id !== id));
      };

      const fileInputRef = useRef(null);

      const handleExport = () => {
        const dataStr = JSON.stringify(payments, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `calendar-payments-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (Array.isArray(imported)) {
              const paymentsWithDates = imported.map(p => ({
                ...p,
                startDate: new Date(p.startDate),
                endDate: p.endDate ? new Date(p.endDate) : null
              }));
              setPayments(paymentsWithDates);
              alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${paymentsWithDates.length} –ø–ª–∞—Ç–µ–∂–µ–π`);
            } else {
              alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
            }
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
          }
        };
        reader.readAsText(file);
        // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ —Å–Ω–æ–≤–∞
        e.target.value = '';
      };

      // –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –¥–∞—Ç–∞–º
      const { upcomingPayments, displayedMonthTotal, displayedYearTotal } = useMemo(() => {
        const displayedMonthStart = startOfMonth(currentMonth);
        const displayedMonthEnd = endOfMonth(currentMonth);
        const displayedYearStart = startOfYear(currentMonth);
        const displayedYearEnd = endOfYear(currentMonth);
        const horizonEnd = addYears(new Date(), 2);

        const upcomingPayments = [];
        let displayedMonthTotal = 0;
        let displayedYearTotal = 0;

        const seenDates = new Set(); // –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

        payments.forEach((p) => {
          const amount = Number(p.amount);
          if (!amount || amount <= 0) return;

          const start = new Date(p.startDate);
          if (isNaN(start.getTime())) return;

          const end = p.endDate ? new Date(p.endDate) : null;

          let d = new Date(start);
          let iteration = 0;
          const maxIterations = 1000; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

          while (d <= horizonEnd && iteration < maxIterations) {
            iteration++;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –ª–∏ –ø–ª–∞—Ç–µ–∂
            if (end && d > end) break;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
            const dateKey = formatDateKey(d);
            const paymentKey = `${p.id}-${dateKey}`;
            if (seenDates.has(paymentKey)) {
              // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π –ø–ª–∞—Ç–µ–∂, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É –¥–∞—Ç—É –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π
              // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –ø–µ—Ä–µ–¥ continue
              if (p.frequency === "yearly") {
                d = addYears(d, 1);
              } else if (p.frequency === "monthly") {
                const originalDayOfMonth = start.getDate();
                let nextDate = addMonths(d, 1);
                const daysInNextMonth = getDaysInMonth(nextDate);
                const targetDay = Math.min(originalDayOfMonth, daysInNextMonth);
                d = new Date(nextDate.getFullYear(), nextDate.getMonth(), targetDay);
              } else if (p.frequency === "weekly") {
                d = addWeeks(d, 1);
              } else {
                break;
              }
              continue;
            }
            seenDates.add(paymentKey);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—Ç–µ–∂
            upcomingPayments.push({
              id: paymentKey,
              baseId: p.id,
              label: p.label,
              amount,
              date: new Date(d),
              frequency: p.frequency,
            });

            // –ü–æ–¥—Å—á–µ—Ç —Å—É–º–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
            if (d >= displayedMonthStart && d <= displayedMonthEnd) {
              displayedMonthTotal += amount;
            }
            if (d >= displayedYearStart && d <= displayedYearEnd) {
              displayedYearTotal += amount;
            }

            // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏
            if (p.frequency === "one-time") {
              break;
            } else if (p.frequency === "yearly") {
              // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —á–∏—Å–ª—É –∏ –º–µ—Å—è—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15 –º–∞—Ä—Ç–∞ –∫–∞–∂–¥–æ–≥–æ –≥–æ–¥–∞)
              d = addYears(d, 1);
            } else if (p.frequency === "monthly") {
              // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —á–∏—Å–ª—É –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 28-–≥–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞)
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏–∑ startDate
              const originalDayOfMonth = start.getDate();
              let nextDate = addMonths(d, 1);
              const daysInNextMonth = getDaysInMonth(nextDate);
              // –ï—Å–ª–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ –¥–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 31-–≥–æ), –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å
              const targetDay = Math.min(originalDayOfMonth, daysInNextMonth);
              d = new Date(nextDate.getFullYear(), nextDate.getMonth(), targetDay);
            } else if (p.frequency === "weekly") {
              // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –¥–Ω—é –Ω–µ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
              d = addWeeks(d, 1);
            }
          }
        });

        upcomingPayments.sort((a, b) => a.date - b.date);

        return { upcomingPayments, displayedMonthTotal, displayedYearTotal };
      }, [payments, currentMonth]);

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –¥–Ω—è–º –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      const paymentsByDate = useMemo(() => {
        const map = {};
        upcomingPayments.forEach((p) => {
          const key = formatDateKey(p.date);
          if (!map[key]) {
            map[key] = [];
          }
          map[key].push(p);
        });
        return map;
      }, [upcomingPayments]);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      const calendarDays = useMemo(() => {
        const days = [];
        const daysInMonth = getDaysInMonth(currentMonth);
        const firstDay = getFirstDayOfMonth(currentMonth);
        
        const prevMonth = addMonths(currentMonth, -1);
        const daysInPrevMonth = getDaysInMonth(prevMonth);
        for (let i = firstDay - 1; i >= 0; i--) {
          const date = new Date(prevMonth.getFullYear(), prevMonth.getMonth(), daysInPrevMonth - i);
          days.push({ date, isCurrentMonth: false });
        }
        
        for (let i = 1; i <= daysInMonth; i++) {
          const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i);
          days.push({ date, isCurrentMonth: true });
        }
        
        const totalCells = days.length;
        const remainingCells = 42 - totalCells;
        const nextMonth = addMonths(currentMonth, 1);
        for (let i = 1; i <= remainingCells; i++) {
          const date = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), i);
          days.push({ date, isCurrentMonth: false });
        }
        
        return days;
      }, [currentMonth]);

      const monthNames = [
        "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
        "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"
      ];

      const weekDays = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

      const frequencies = [
        { value: "one-time", label: "–†–∞–∑–æ–≤—ã–π", icon: "üìÖ" },
        { value: "weekly", label: "–ù–µ–¥–µ–ª—è", icon: "üìÜ" },
        { value: "monthly", label: "–ú–µ—Å—è—Ü", icon: "üóìÔ∏è" },
        { value: "yearly", label: "–ì–æ–¥", icon: "üìÖ" }
      ];

      const handlePrevMonth = () => {
        setCurrentMonth(addMonths(currentMonth, -1));
      };

      const handleNextMonth = () => {
        setCurrentMonth(addMonths(currentMonth, 1));
      };

      const handleToday = () => {
        setCurrentMonth(new Date());
      };

      return (
        <div className="min-h-screen bg-slate-50 relative">
          {/* –ù–µ–∑–∞–º–µ—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ */}
          <div className="fixed bottom-4 right-4 z-40 flex gap-2">
            <input
              type="file"
              accept=".json"
              ref={fileInputRef}
              onChange={handleImport}
              className="hidden"
            />
            <button
              onClick={handleExport}
              className="w-10 h-10 rounded-full bg-slate-200/80 hover:bg-slate-300/80 backdrop-blur-sm flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all opacity-30 hover:opacity-100 shadow-lg"
              title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
            </button>
            <button
              onClick={() => fileInputRef.current?.click()}
              className="w-10 h-10 rounded-full bg-slate-200/80 hover:bg-slate-300/80 backdrop-blur-sm flex items-center justify-center text-slate-600 hover:text-slate-800 transition-all opacity-30 hover:opacity-100 shadow-lg"
              title="–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
            </button>
          </div>

          {/* –®–∞–ø–∫–∞ —Å —Å—É–º–º–∞–º–∏ */}
          <div className="bg-white border-b border-slate-200 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <h1 className="text-2xl font-semibold text-slate-900 mb-4">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–ª–∞—Ç–µ–∂–µ–π</h1>
              <div className="flex gap-6">
                <div className="bg-slate-50 rounded-lg px-4 py-3 border border-slate-200">
                  <div className="text-xs text-slate-500 mb-1">
                    –°—É–º–º–∞ –≤ {monthNames[currentMonth.getMonth()].toLowerCase()}–µ {currentMonth.getFullYear()}
                  </div>
                  <div className="text-xl font-semibold text-slate-900">
                    {formatAmount(displayedMonthTotal)} ‚ÇΩ
                  </div>
                </div>
                <div className="bg-slate-50 rounded-lg px-4 py-3 border border-slate-200">
                  <div className="text-xs text-slate-500 mb-1">
                    –°—É–º–º–∞ –≤ {currentMonth.getFullYear()} –≥–æ–¥—É
                  </div>
                  <div className="text-xl font-semibold text-slate-900">
                    {formatAmount(displayedYearTotal)} ‚ÇΩ
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */}
          <div className="max-w-7xl mx-auto px-4 py-6">
            <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
              {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º */}
              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <div className="flex items-center gap-4">
                  <button
                    onClick={handlePrevMonth}
                    className="p-2 hover:bg-slate-100 rounded-full transition-colors"
                  >
                    <svg className="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <h2 className="text-lg font-semibold text-slate-900">
                    {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
                  </h2>
                  <button
                    onClick={handleNextMonth}
                    className="p-2 hover:bg-slate-100 rounded-full transition-colors"
                  >
                    <svg className="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
                <button
                  onClick={handleToday}
                  className="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg transition-colors"
                >
                  –°–µ–≥–æ–¥–Ω—è
                </button>
              </div>

              {/* –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */}
              <div className="p-6">
                {/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ */}
                <div className="grid grid-cols-7 gap-1 mb-2">
                  {weekDays.map((day) => (
                    <div key={day} className="text-center text-xs font-medium text-slate-500 py-2">
                      {day}
                    </div>
                  ))}
                </div>

                {/* –î–Ω–∏ –º–µ—Å—è—Ü–∞ */}
                <div className="grid grid-cols-7 gap-1">
                  {calendarDays.map((day, index) => {
                    const dayKey = formatDateKey(day.date);
                    const dayPayments = paymentsByDate[dayKey] || [];
                    const isToday = isSameDay(day.date, new Date());
                    const totalForDay = dayPayments.reduce((sum, p) => sum + p.amount, 0);

                    return (
                      <div
                        key={index}
                        onClick={() => handleDayClick(day.date)}
                        className={`
                          min-h-[80px] p-2 border border-slate-200 rounded-lg cursor-pointer
                          transition-all hover:bg-slate-50 hover:border-indigo-300
                          ${day.isCurrentMonth ? 'bg-white' : 'bg-slate-50 opacity-50'}
                          ${isToday ? 'ring-2 ring-indigo-500 border-indigo-500' : ''}
                        `}
                      >
                        <div className={`
                          text-sm font-medium mb-1
                          ${isToday ? 'text-indigo-600' : day.isCurrentMonth ? 'text-slate-900' : 'text-slate-400'}
                        `}>
                          {day.date.getDate()}
                        </div>
                        {dayPayments.length > 0 && (
                          <div className="space-y-1">
                            {dayPayments.slice(0, 2).map((p) => (
                              <div
                                key={p.id}
                                onClick={(e) => handlePaymentClick(e, p)}
                                className="text-xs px-1.5 py-0.5 bg-indigo-100 text-indigo-700 rounded truncate cursor-pointer hover:bg-indigo-200 transition-colors"
                                title={`${p.label} - ${formatAmount(p.amount)} ‚ÇΩ (–∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)`}
                              >
                                {p.label}
                              </div>
                            ))}
                            {dayPayments.length > 2 && (
                              <div className="text-xs text-slate-500">
                                +{dayPayments.length - 2}
                              </div>
                            )}
                            {totalForDay > 0 && (
                              <div className="text-xs font-semibold text-slate-900 mt-1">
                                {formatAmount(totalForDay)} ‚ÇΩ
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */}
          {modalOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-slate-900">
                    {editingPaymentId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂' : '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂'}
                  </h3>
                  <button
                    onClick={handleCloseModal}
                    className="text-slate-400 hover:text-slate-600"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                <div className="mb-4">
                  <div className="text-sm text-slate-500 mb-2">
                    –î–∞—Ç–∞: {selectedDate?.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                  </div>
                </div>

                {clickedPaymentInstance && (
                  <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                    <p className="text-sm text-amber-800 mb-2">
                      –≠—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –ø–ª–∞—Ç—ë–∂. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞, –Ω–µ —É–¥–∞–ª—è—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ.
                    </p>
                    <button
                      onClick={handleCancelFromNow}
                      className="text-sm text-amber-700 hover:text-amber-900 font-medium underline"
                    >
                      –û—Ç–º–µ–Ω–∏—Ç—å —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞
                    </button>
                  </div>
                )}

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                      –ù–∞–∑–≤–∞–Ω–∏–µ
                    </label>
                    <input
                      type="text"
                      className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                      placeholder="Spotify, –∞—Ä–µ–Ω–¥–∞, –¥–æ–º–µ–Ω‚Ä¶"
                      value={formLabel}
                      onChange={(e) => setFormLabel(e.target.value)}
                      onKeyPress={handleKeyPress}
                      autoFocus
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-2">
                      –°—É–º–º–∞: {formatAmount(sliderValue)} ‚ÇΩ
                    </label>
                    <div className="space-y-3">
                      <input
                        type="range"
                        min="100"
                        max="100000"
                        step="100"
                        value={sliderValue}
                        onChange={handleSliderChange}
                        className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer slider"
                        ref={sliderRef}
                        style={{
                          background: `linear-gradient(to right, #4f46e5 0%, #4f46e5 ${(sliderValue - 100) / (100000 - 100) * 100}%, #e2e8f0 ${(sliderValue - 100) / (100000 - 100) * 100}%, #e2e8f0 100%)`
                        }}
                      />
                      <input
                        type="text"
                        inputMode="decimal"
                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                        value={formAmount}
                        onChange={handleAmountInputChange}
                        onKeyPress={handleKeyPress}
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-2">
                      –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å
                    </label>
                    <div className="relative bg-slate-100 rounded-lg p-1 flex">
                      {frequencies.map((freq) => {
                        const isActive = formFrequency === freq.value;
                        return (
                          <button
                            key={freq.value}
                            onClick={() => setFormFrequency(freq.value)}
                            className={`
                              flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-md text-sm font-medium
                              transition-all duration-200 ease-in-out
                              ${isActive 
                                ? 'bg-white text-indigo-600 shadow-sm transform scale-105' 
                                : 'text-slate-600 hover:text-slate-900'
                              }
                            `}
                          >
                            <span className="text-base">{freq.icon}</span>
                            <span>{freq.label}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  <div className="flex gap-3 pt-2">
                    {editingPaymentId && !clickedPaymentInstance && (
                      <button
                        onClick={() => {
                          handleRemovePayment(editingPaymentId);
                          handleCloseModal();
                        }}
                        className="px-4 py-2 rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition-colors"
                      >
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    )}
                    <button
                      onClick={handleCloseModal}
                      className="flex-1 px-4 py-2 rounded-lg text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors"
                    >
                      –û—Ç–º–µ–Ω–∞
                    </button>
                    <button
                      onClick={handleAddPayment}
                      className="flex-1 px-4 py-2 rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors"
                    >
                      {editingPaymentId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SubscriptionCalendarApp />);
  </script>
</body>
</html>
